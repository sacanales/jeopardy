from flask import Flask, render_template, request, redirect, url_for, session, abort
import os

app = Flask(__name__)
app.secret_key = os.urandom(24)

SIMPLE_PASSWORD = 'gbsstinks'

# Define categories and questions with explanations
categories = {
    "Epidemiology": {
        100: ("A 32-year-old G2P1 woman presents to labor and delivery at 37 weeks gestation. She reports the rupture of membranes 2 hours ago. She has not received any prenatal care. Given her situation, identify the key factor from her history that would increase her newborn's risk for this infectious condition.", "What is lack of prenatal care increasing the risk for Group B Streptococcus (GBS) disease?", "The vignette describes a situation where a pregnant woman has not received any prenatal care and reports premature rupture of membranes at 37 weeks gestation. Lack of prenatal care is a significant risk factor for neonatal GBS disease because it means the mother has likely not been screened for GBS colonization during the third trimester, as is recommended. Therefore, the absence of prenatal care directly impacts the newborn's risk for GBS infection, particularly early-onset disease, which can occur in the first week of life."),
        
        200: ("A newborn is diagnosed with late-onset GBS disease at 5 weeks of age. The mother recalls being told her GBS status was negative during pregnancy. Considering the age of onset, what is a significant risk factor for this type of GBS disease presentation?", "What is horizontal transmission from caregivers or environmental sources?", "The highlighted risk factor in this scenario, horizontal transmission from caregivers or environmental sources, refers to the acquisition of GBS after birth from contacts or surroundings, rather than directly from the mother at the time of delivery. Caregivers, including family members, healthcare workers, or others who have close contact with the infant, can inadvertently transmit GBS bacteria to the child through direct contact. Environmental sources can also harbor GBS, although less commonly, and lead to neonatal infection."),
        
        300: ("A neonatologist is reviewing the case of a term neonate admitted with late-onset GBS meningitis. The infants mother was GBS-negative at 36 weeks gestation, and the delivery was uncomplicated. Which environmental or postnatal factor is increasingly recognized as a potential risk for late-onset GBS disease in neonates, highlighting the complexity of transmission routes beyond maternal vertical transmission?", "What is horizontal transmission from hospital or community contacts?", "Late-onset GBS disease, which occurs between 7 days and 3 months of age, can be attributed to horizontal transmission from sources other than the mother, including hospital staff, family members, or other community contacts. This emphasizes the importance of hygiene practices in the care of newborns and demonstrates that GBS infection can occur via multiple pathways, not exclusively through maternal vertical transmission. Understanding and addressing these additional risk factors are crucial for preventing late-onset GBS disease."),
        
        400: ("Which of the following is the most common bacterium recovered from breast abscesses in newborns? A. Streptococcus pyogenes B. Streptococcus agalactiae C. Staphylococcus aureus D. Listeria monocytogenes E. Escherichia coli", "What is Staphylococcus aureus?", "Staphylococcus aureus is responsible for over 90% of breast abscesses in newborns. Empiric antibiotic coverage should include an antistaphylococcal antibiotic. In areas where community-acquired MRSA is high, use of an antibiotic with activity against MRSA such as clindamycin, trimethoprim/sulfamethoxazole (TMP/SMX), or vancomycin is indicated empirically; otherwise, oxacillin or cephalexin is appropriate. At this age, TMP/SMX would not be preferred because sulfa can displace bilirubin from protein binding sites and worsen hyperbilirubinemia. E. coli and Streptococcus agalactiae (group B Streptococcus [GBS]) are most commonly identified as causes of neonatal sepsis though are less likely causes of an isolated abscess of skin or soft tissue in neonates than S. aureus. While cellulitis/adenitis is a manifestation of late-onset GBS disease, breast abscesses specifically (as opposed to cellulitis and adenitis) are most often a result of S. aureus. Group A Streptococcus (S. pyogenes) is a rare cause of infection in the neonatal age and less likely to cause abscesses than S. aureus. Listeria monocytogenes is a rare cause of neonatal sepsis and meningitis. Maternal ingestion of contaminated cheeses, dairy products, or other foods can lead to fetomaternal listeriosis. Infected newborns may occasionally develop pyogenic granulomas over their whole body (called granulomatosis infantisepticum).")
    },
    "Prevention and Screening": {
        100: ("A 28-year-old pregnant woman at 35 weeks gestation is found to have GBS colonization. She is allergic to penicillin with a history of anaphylaxis. Based on her allergy status, which antibiotic should be administered for intrapartum prophylaxis?", "What is clindamycin (if GBS is susceptible) or vancomycin?", "This question focuses on an expectant mother who is known to be colonized with GBS but also has a history of anaphylaxis to penicillin, making the preferred antibiotic choice (penicillin or ampicillin) unsuitable for her. In such cases, alternative antibiotics are considered based on GBS susceptibility. Clindamycin is an option if the GBS strain is susceptible to it. However, if the GBS strain is resistant to clindamycin or if susceptibility cannot be determined, vancomycin becomes the antibiotic of choice for intrapartum prophylaxis."),
        
        200: ("During a routine prenatal visit at 36 weeks gestation, a pregnant woman undergoes screening for GBS. The result is positive. She has no known drug allergies. Given the current guidelines, what is the recommended course of action to prevent early-onset GBS disease in her newborn?", "What is administering intrapartum antibiotic prophylaxis (IAP) with penicillin or ampicillin during labor?", "For pregnant women found to be colonized with GBS during routine screening, the current recommendation to prevent early-onset GBS disease in their newborns is to administer intrapartum antibiotic prophylaxis (IAP) during labor. Penicillin or ampicillin is the preferred treatment due to their efficacy against GBS, low risk of side effects, and ability to reduce the transmission of GBS from mother to baby during the birthing process. Must be given ≥4 hours prior to delivery."),
        
        300: ("A 29-year-old woman at 37 weeks gestation is admitted for labor induction. Her prenatal course was complicated by a positive GBS urine culture at 16 weeks and a penicillin allergy without anaphylaxis. She received an alternative antibiotic treatment for the UTI but is concerned about her baby's risk at delivery. What specific intervention should be provided to minimize the risk of neonatal GBS disease given her allergy status and GBS history?", "What is the administration of cefazolin for intrapartum antibiotic prophylaxis because of the low risk of anaphylaxis in penicillin-allergic patients without a history of anaphylaxis to penicillin?", "In a penicillin-allergic patient without a history of anaphylaxis to penicillin, cefazolin is preferred due to its efficacy and lower risk of cross-reactivity. This approach minimizes neonatal GBS disease risk while considering the maternal allergy status."),
        
        400: ("A 1-day-old infant with no history of prenatal care presents with fever and mottling. The mother delivered the infant at home. Which of the following presentations would be most likely for group B Streptococcus infection at this age? A. Septic arthritis B. Cellulitis C. Septicemia D. Meningitis E. Osteomyelitis", "What is Septicemia?", "For an infant up to 6 days of age, the most common presentation for early-onset group B Streptococcus (GBS; Streptococcus agalactiae) sepsis is frank septicemia (45%) or pneumonia (40%). Meningitis occurs in < 10% of infants at this age. Bacteremia without a focus, meningitis, septic arthritis, osteomyelitis, and cellulitis/adenitis are more likely to occur with late-onset GBS infection in infants 7 days to 3 months of age."),
    },
    "Clinical Manifestations": {
        100: ("A term newborn is noted to be lethargic and feed poorly 24 hours post-delivery. The infant is also observed to have a temperature instability. What is the most important disease to rule out given these clinical manifestations?", "What is early-onset Group B Streptococcus (GBS) sepsis?", "The newborn presented in this vignette displays lethargy, poor feeding, and temperature instability within the first 24 hours after birth, which are concerning signs suggestive of neonatal sepsis. Given the specified timeframe and clinical presentation, early-onset GBS sepsis is a crucial condition to consider and rule out. Early-onset GBS disease, occurring within the first seven days of life, typically presents with signs of systemic infection such as temperature irregularities, respiratory distress, and feeding difficulties. Identifying these symptoms prompts immediate evaluation, including laboratory tests and initiation of empirical antibiotic therapy while awaiting culture results, to manage the condition effectively and mitigate potential complications associated with neonatal sepsis."),
        
        200: ("A 2-month-old infant presents with fever, irritability and a bulging fontanelle. Blood cultures are drawn and an empiric antibiotic course is started. What condition should be strongly considered in the differential diagnosis given the signs and potential exposure history?", "What is late-onset GBS meningitis?", "This clinical scenario describes a 36-hour-old neonate manifesting signs of respiratory distress—grunting, nasal flaring, and retractions—compounded by decreased activity and feeding interest. These symptoms, particularly when observed in a neonate born to a mother with a history of inadequately treated Group B Streptococcus (GBS) colonization, raise substantial concern for early-onset GBS sepsis."),
        
        300: ("A 4-week-old previously healthy infant presents with fever, increased irritability, and a high-pitched cry. Physical examination reveals poor feeding and bulging of the anterior fontanelle upon crying. The infant was delivered at term with an uncomplicated delivery, and the mother reports that she was GBS-negative during prenatal screening. Considering the clinical presentation and the initial negative maternal history for GBS, what significant infectious condition must be ruled out, and what diagnostic procedure is imperative to perform next?", "What is meningitis, necessitating immediate lumbar puncture for cerebrospinal fluid analysis?", "A 4-week-old infant presenting with fever, irritability, poor feeding, and bulging fontanelle, suggestive of increased intracranial pressure, must be evaluated for meningitis. Regardless of initial maternal GBS screening results, meningitis remains a critical consideration in febrile infants with neurological symptoms, and immediate lumbar puncture is necessary for diagnostic cerebrospinal fluid analysis."),
        
        400: ("A 3-day-old female born at 32 weeks of gestation is noted to be lethargic with poor tone and a respiratory rate of 65 breaths/minute. Her rectal temperature is 35.8°C (96.5°F). Blood and cerebrospinal fluid cultures are obtained. Examination of the cerebrospinal fluid reveals 1,100 WBCs/μL, protein concentration of 170 mg/dL, and glucose concentration of 20 mg/dL. Which of the following is the most appropriate initial treatment in this patient? Is it A. Ampicillin B. Ampicillin and cefotaxime C. Ampicillin and metronidazole D. Ampicillin and acyclovir E. Ceftriaxone and gentamicin", "What is Ampicillin and cefotaxime?", "Explanation: The patient has clinical and laboratory findings consistent with bacterial meningitis. In neonates < 7 days old, the most common bacterial pathogens are group B Streptococcus (GBS), Escherichia coli, Listeria monocytogenes, and other enteric organisms. Older hospitalized neonates are at risk of a wide variety of additional potential pathogens, including Serratia marcescens, Pseudomonas aeruginosa, Klebsiella species, and Citrobacter species. Initial empiric therapy for suspected bacterial meningitis in neonates under 7 days of age is ampicillin plus cefotaxime. In addition to covering GBS and susceptible enteric Gram-negative organisms, ampicillin provides good coverage for Listeria monocytogenes and most enterococci. Cefotaxime, a 3rd generation cephalosporin with excellent penetration into the cerebrospinal fluid, provides adequate empiric coverage for most of the Gram-negative bacteria that cause neonatal meningitis. It will not cover Pseudomonas or resistant Gram-negative organisms; however, these less common causes of meningitis are usually seen in older neonates who have been hospitalized. When cefotaxime is not available due to drug shortages, another advanced generation cephalosporin (e.g., cefepime, ceftazidime) may be used as an alternative. The same empiric treatment regimen is also recommended in infants > 7 days of age who had previously not been hospitalized presenting with bacterial meningitis. For the other hospitalized neonate, using a broader cephalosporin, in addition to ampicillin, is justified to cover the possibility of other organisms as mentioned above. The most common clinical feature associated with neonatal meningitis is temperature instability, with hypothermia more common in preterm infants, and hyperthermia more common among term infants. Other findings may include irritability, poor feeding, lethargy, decreased tone, full (often not bulging) fontanelle, tachypnea, periods of apnea, and seizures. Signs of seizure activity in this age group may be subtle (e.g., lip smacking, tongue thrusting, ocular movements, poor tone). Bacterial pathogens may be first identified on Gram stain and then by cerebrospinal fluid culture. The cerebrospinal fluid typically reveals an elevated (> 1,000/μL) WBC count, elevated protein concentration (> 150 mg/dL in preterm; > 100 mg/dL in term infants), and decreased glucose concentration (< 20 mg/dL in preterm; < 30 mg/dL in term infants). The other answer choices given do not completely cover the most likely pathogens in neonates. Ampicillin monotherapy, ampicillin given with metronidazole or acyclovir or ampicillin plus ceftriaxone would not provide adequate empiric coverage for E. coli and other enteric organisms. Gentamicin, an aminoglycoside, does not have good blood brain barrier penetration and should not be used for treating neonatal meningitis. It is, however, recommended in combination with ampicillin for empiric treatment of neonatal sepsis. Ceftriaxone, while similar in its coverage to cefotaxime, should be avoided in neonates as it may worsen hyperbilirubinemia and has cautions against its use in neonates due to its potential for increasing the risk of bilirubin encephalopathy. It is contraindicated in neonates receiving or who may receive intravenous calcium products (due to serious health risks associated with precipitate formation)."),
    },
    "Treatment and Management": {
        100: ("A newborn is diagnosed with early-onset GBS disease shortly after birth. The infant's mother was positive for GBS but allergic to penicillin. Considering the newborn's diagnosis and symptoms including respiratory distress and fever, what is the first-line treatment option for this infant?", "What is IV antibiotics, specifically penicillin G or ampicillin plus gentamicin?", "The first-line treatment for a newborn diagnosed with early-onset GBS disease involves the immediate administration of intravenous antibiotics. Penicillin G or ampicillin and Gentamicin (empiric coverage) until the specific causative agent is confirmed."),
        
        200: ("A preterm neonate born at 34 weeks gestation is suspected of having early-onset GBS infection and is started on empiric antibiotics. What two antibiotics should be initially chosen to cover for the most likely pathogens, including GBS?", "What are ampicillin and gentamicin?", "Ampicillin is effective against GBS and other gram-positive organisms, which are common pathogens in neonatal infections. Its broad spectrum also covers certain gram-negative bacteria and Listeria monocytogenes, another critical pathogen in neonates, especially those born prematurely. Gentamicin is added to provide synergistic effects against gram-negative bacteria, enhancing the coverage against a broader range of potential pathogens."),
        
        300: ("A 2-week-old neonate, previously healthy, presents to the pediatric emergency department with a 1-day history of fever, irritability, and decreased oral intake. The infant was born at term following an uncomplicated pregnancy, and the mother's GBS status was negative at 36 weeks gestation. Despite the maternal GBS-negative status, the neonate is diagnosed with late-onset GBS meningitis. After initiating appropriate antibiotic therapy, what critical aspect of supportive care is essential to monitor and potentially adjust in this patient's management plan?", "What is the monitoring and managing of potential complications, such as hydrocephalus or seizures, as part of the comprehensive care for neonatal meningitis?", "An infant diagnosed with late-onset GBS meningitis requires not only appropriate antibiotic therapy but also vigilant supportive care. Monitoring for and managing potential complications, such as seizures and hydrocephalus, are crucial due to the inflammatory responses in the meninges and potential increased intracranial pressure or direct injury to the neural tissue caused by the infection."),
        
        400: ("A 2-week-old infant presents with a 24-hour history of poor feeding and irritability. On physical examination, his temperature is 101.2°F (38.4°C). He is lethargic, difficult to arouse, and has a bulging anterior fontanelle. Findings on lumbar puncture include a WBC count of 8,600/µL, protein of 190 mg/dL, glucose of 22 mg/dL, and a Gram stain revealing gram-negative rods. An MRI reveals abscess formation in both frontal lobes along with meningeal enhancement consistent with meningitis. Which of the following is the most likely cause of this patient’s clinical, laboratory, and neuroimaging findings? Is it A) GBS B) Citrobacter koseri C) E coli D) HSV E) Listeria", "What is Citrobacter koseri?", "Considering the patient's age, CSF findings, and MRI results, Citrobacter is the most likely cause of his brain abscess formation. Clinical findings associated with an abscess may include lethargy, poor feeding, vomiting, and a bulging fontanelle associated with a rapidly increasing head circumference and separation of the cranial sutures. Focal seizures are common. If brain abscess is suspected, neuroimaging should be performed. Contrast-enhanced CT or MRI findings of a brain abscess include a well-circumscribed region(s) of decreased attenuation and contrast enhancement of the rim associated with edema secondary to cerebritis. The duration of antimicrobial treatment of a brain abscess is generally 6–8 weeks. Prior to identification of the causative organism and its susceptibility profile, empiric therapy for neonatal meningitis with ampicillin, an aminoglycoside, and cefotaxime is recommended. Mortality rates are high among infants who develop a brain abscess. Those who survive commonly have a residual seizure disorder and are developmentally delayed, secondary to chronic central nervous system complications including porencephaly and/or encephalomalacia. In addition to Citrobacter, there is an increased risk of brain abscess in the neonatal population when gram-negative organisms are the source, including Cronobacter sakazakii (formerly an Enterobacter), Proteus, and, less likely, Escherichia coli. While Listeria monocytogenes and group B streptococci may cause brain abscess formation, they are less common. Herpes simplex virus (HSV) can look very similar clinically, but is differentiated from a bacterial process by the lower glucose and presence of an abscess. Early CT findings in neonatal HSV are generally normal and MRI is more sensitive at detecting areas of encephalitis."),
    },
}

@app.before_request
def before_request():
    # Add login check, excluding paths that don't require authentication
    if not session.get('logged_in') and request.endpoint not in ['login', 'static']:
        return redirect(url_for('login'))

    if request.endpoint == 'game' and 'teams' not in session:
        return redirect(url_for('index'))
    if 'answered_questions' not in session:
        session['answered_questions'] = []

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        team1 = request.form.get('team1', 'Team 1')
        team2 = request.form.get('team2', 'Team 2')
        session['teams'] = {team1: 0, team2: 0}
        return redirect(url_for('game'))
    return render_template('index.html')

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        password = request.form.get('password')
        if password == SIMPLE_PASSWORD:
            session['logged_in'] = True
            return redirect(url_for('index'))
        else:
            # Optionally, provide feedback on failed login attempt
            return "Invalid password, please try again.", 401
    return '''
        <form method="post">
            Password: <input type="password" name="password">
            <input type="submit" value="Login">
        </form>
    '''

@app.route('/game')
def game():
    return render_template('game.html', categories=categories, teams=session['teams'], answered_questions=session['answered_questions'])

@app.route('/question/<category>/<int:value>', methods=['GET', 'POST'])
def question(category, value):
    if request.method == 'POST':
        team = request.form.get('team')
        correct = request.form.get('correct') == 'true'
        
        # Check if the response was from the "Nobody" button and handle accordingly
        if team != "Nobody" and correct:
            # Update team score if correct
            session['teams'][team] += value
        # Mark the question as answered regardless of who answered or if it was correct
        session['answered_questions'].append(f"{category}_{value}")
        session.modified = True
        return redirect(url_for('game'))
    
    question, answer, explanation = categories[category][value]
    return render_template('question.html', category=category, value=value, question=question, answer=answer, explanation=explanation, teams=session['teams'])

if __name__ == '__main__':
    app.run(debug=True)